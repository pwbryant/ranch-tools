{% load custom_filters %}
{% load static %}
<link rel="stylesheet"  type="text/css" href="{% static 'preg_check/styles.css' %}">

<div class="container">
	<div id="stats-content">
		<!-- Summary stats will be displayed here -->
	</div>

  <div class="form-container">
    <form id="search-form" method="get" action="">
      {{ search_form.as_p }}
      <button type="submit">Search For Animal</button>
    </form>

    <div class="result-container">
     {% if multiple_matches %}
        <p>More than one animal is associated with this ID with birth years of
        {% for birth_year in distinct_birth_years %}
            {{ birth_year }}{% if not forloop.last %}, {% endif %}
        {% endfor %}.
        <br>Please provide the birth year to select the desired animal.
        </p>
      {% elif pregchecks %}
      <table>
         <thead>
            <tr>
              <th>Preg Status</th>
              <th>Check Date</th>
              <th>Breeding Season</th>
              {% if pregchecks|has_comments %}
                  <th>Comments</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for pregcheck in pregchecks %}
              <tr>
                {% if pregcheck.is_pregnant %}
                    <td>Pregnant</td>
                {% else %}
                    <td>Open</td>
                {% endif %}
                <td>{{ pregcheck.check_date }}</td>
                <td>{{ pregcheck.breeding_season }}</td>
                {% if pregcheck.comments %}
                    <td>{{ pregcheck.comments }}</td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>	
      {% else %}
        {% if search_form.is_bound %}
          <p>Animal ID not found</p>
        {% endif %}
      {% endif %}
    </div>
  </div>
<div class="form-container">

<form id="pregcheck-form" method="post" action="{% url 'pregcheck-create' %}">
  {% csrf_token %}
  <label for="{{ pregcheck_form.pregcheck_animal_id.id_for_label }}">Animal ID</label>
  {{ pregcheck_form.pregcheck_animal_id }}
  <label for="{{ pregcheck_form.breeding_season.id_for_label }}">Breeding Season</label>
  {{ pregcheck_form.breeding_season }}
  <label for="{{ pregcheck_form.comments.id_for_label }}">Comments</label>
  {{ pregcheck_form.comments }}
  <label for="{{ pregcheck_form.is_pregnant.id_for_label }}">Status</label>
  {{ pregcheck_form.is_pregnant }}
  <div class="form-group">
      <label for="{{ pregcheck_form.recheck.id_for_label }}">Recheck</label>
      <div class="checkbox-input">
          {{ pregcheck_form.recheck }}
      </div>
  </div>
  <button id="submit-btn" type="submit" {% if pregcheck_form.fields.is_pregnant.widget.attrs.disabled %}disabled{% endif %}>
    Submit Preg Check
  </button>
</form>
</div>

<div id="message-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="message-container"></div>
    <button id="continue-btn">Continue</button>
  </div>
</div>

<!-- Add this modal at the end of the template -->
<div id="no-animal-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <p>There is no animal associated with this ID. To create a new one, provide the birth year (optional) and click the "Create" button.</p>
	<form id="create-animal-form" action="{% url 'cow-create' %}" method="post">
	  {% csrf_token %}
	  <label for="new_animal_id">Animal ID</label>
	  <input type="text" id="new_animal_id" name="animal_id" value="{{ animal_id }}" readonly required>
	  <label for="new_birth_year">Birth Year (optional)</label>
	  <input type="text" id="new_birth_year" name="birth_year">
	  <button id="create-animal-btn" type="submit">Create</button>
	  <button id="cancel-create-btn" type="button">Cancel</button>
	</form>
  </div>
</div>



<script>
    // Function to calculate and display summary stats
	function updateStats() {
		// Make an AJAX request to fetch the summary stats
		const statsContent = document.getElementById('stats-content');
		fetch('{% url "pregcheck-summary-stats" %}')
			.then(response => response.json())
			.then(data => {
				// Update the stats content with the fetched data
				statsContent.innerHTML = `
					<h2>Summary Stats</h2>
					<p>Total Pregnant: ${data.total_pregnant}</p>
					<p>Total Open: ${data.total_open}</p>
					<p>Total Count: ${data.total_count}</p>
					<p>Pregnancy Rate: ${data.pregnancy_rate.toFixed(2)}%</p>
				`;
			})
			.catch(error => {
				console.error('Error fetching summary stats:', error);
				statsContent.innerHTML = 'Error fetching summary stats.';
			});
	}
  document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('pregcheck-form');
    var messageContainer = document.getElementById('message-container');
    var modal = document.getElementById('message-modal');
    var continueBtn = document.getElementById('continue-btn');
    var resultContainer = document.querySelector('.result-container');

    form.addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent normal form submission
      var formData = new FormData(form);
        console.log('submit', formData);

      var xhr = new XMLHttpRequest();
      xhr.open(form.method, form.action, true);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      xhr.onload = function() {
        if (xhr.status === 200) {
          // Display success message
          messageContainer.textContent = 'PregCheck created successfully';
          messageContainer.classList.add('success');
          modal.style.display = 'block';

        // Reset the form inputs
        form.reset();
        document.getElementById('id_search_animal_id').value = '';
        // Remove animal_id input and label
        var animalIdInput = document.getElementById('id_pregcheck_animal_id');
        var animalIdLabel = document.querySelector('label[for="id_pregcheck_animal_id"]');
        if (animalIdInput && animalIdLabel) {
              animalIdInput.remove();
              animalIdLabel.remove();
        }

        // Clear result container
        var resultContainer = document.querySelector('.result-container');
        if (resultContainer) {
              resultContainer.innerHTML = '';
        }

		// Update summary stats
		updateStats();

        // Remove query parameters from URL
        if (window.history && window.history.replaceState) {
              var newUrl = window.location.href.split('?')[0];
              window.history.replaceState({ path: newUrl }, '', newUrl);
        }
        } else {
          // Display error message
          messageContainer.textContent = 'Something went wrong';
          messageContainer.classList.add('error');
          modal.style.display = 'block';
        }
      };
      xhr.onerror = function() {
        // Display error message
        messageContainer.textContent = 'Something went wrong';
        messageContainer.classList.add('error');
        modal.style.display = 'block';
      };
      xhr.send(formData);
    });

    continueBtn.addEventListener('click', function() {
      modal.style.display = 'none';
    });

    var closeModal = function() {
      modal.style.display = 'none';
    };

    var closeBtn = document.querySelector('.close');
    if (closeBtn) {
      closeBtn.addEventListener('click', closeModal);
    }

    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        closeModal();
      }
    });

    // Initially hide the modal
    modal.style.display = 'none';

    // Update summary stats
    updateStats();


  // New animal creation ---------------------------------------
  var noAnimalModal = document.getElementById('no-animal-modal');
  var createAnimalForm = document.getElementById('create-animal-form');
  var createAnimalBtn = document.getElementById('create-animal-btn');
  var cancelCreateBtn = document.getElementById('cancel-create-btn');

  // Function to open the no-animal modal
  function openNoAnimalModal(animalId) {
    noAnimalModal.style.display = 'block';
    document.getElementById('new_animal_id').value = animalId;
  }

  // Function to close the no-animal modal
  function closeNoAnimalModal() {
    noAnimalModal.style.display = 'none';
  }

  var animalExists = "{{ animal_exists }}";
  if(animalExists === "False") {
      openNoAnimalModal(document.getElementById('id_search_animal_id').value);
  } else {
      closeNoAnimalModal();
  }
  // Handle clicks on the "Create" button
  createAnimalBtn.addEventListener('click', function() {
    var newAnimalId = document.getElementById('new_animal_id').value;
    var newBirthYear = document.getElementById('new_birth_year').value;
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Make a POST request to create the new animal
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '{% url "cow-create" %}', true);
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.setRequestHeader('X-CSRFToken', csrfToken);
    xhr.onload = function() {
      if (xhr.status === 200) {
        // Display a success message if needed
        console.log('Animal created successfully');

        // Close the modal
        closeNoAnimalModal();

        // Trigger a search with the newly created animal_id
        document.getElementById('id_search_animal_id').value = newAnimalId;
        document.getElementById('search-form').submit();
      } else {
        // Display an error message if something went wrong
        console.error('Error creating animal:', xhr.responseText);
      }
    };
    xhr.onerror = function() {
      // Display an error message if the request fails
      console.error('Error creating animal: Request failed');
    };
    var formData = new FormData();
    formData.append('pregcheck_animal_id', newAnimalId);
    formData.append('birth_year', newBirthYear);
    xhr.send(formData);
  });

  // Handle clicks on the "Cancel" button
  cancelCreateBtn.addEventListener('click', function() {
    closeNoAnimalModal();
  });

  });
</script>


