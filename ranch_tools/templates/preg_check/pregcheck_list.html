{% load custom_filters %}
{% load static %}
<link rel="stylesheet"  type="text/css" href="{% static 'preg_check/styles.css' %}">

<div class="container">
  <div class="form-container">
    <form id="search-form" method="get" action="">
      {{ search_form.as_p }}
      <button type="submit">Search For Animal</button>
    </form>

    <div class="result-container">
      {% if pregchecks %}
      <table>
         <thead>
            <tr>
              <th>Preg Status</th>
              <th>Check Date</th>
              <th>Breeding Season</th>
              {% if pregchecks|has_comments %}
                  <th>Comments</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for pregcheck in pregchecks %}
              <tr>
                <td>{{ pregcheck.pregnant }}</td>
                <td>{{ pregcheck.check_date }}</td>
                <td>{{ pregcheck.breeding_season }}</td>
                {% if pregcheck.comments %}
                    <td>{{ pregcheck.comments }}</td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>	
      {% else %}
        {% if search_form.is_bound %}
          <p>Animal ID not found</p>
        {% endif %}
      {% endif %}
    </div>
  </div>
<div class="form-container">

<form id="pregcheck-form" method="post" action="{% url 'pregcheck-create' %}">
  {% csrf_token %}
  <label for="{{ pregcheck_form.pregcheck_animal_id.id_for_label }}">Animal ID</label>
  {{ pregcheck_form.pregcheck_animal_id }}
  <label for="{{ pregcheck_form.breeding_season.id_for_label }}">Breeding Season</label>
  {{ pregcheck_form.breeding_season }}
  <label for="{{ pregcheck_form.comments.id_for_label }}">Comments</label>
  {{ pregcheck_form.comments }}
  <label for="{{ pregcheck_form.pregnant.id_for_label }}">Status</label>
  {{ pregcheck_form.pregnant }}
  <button id="submit-btn" type="submit" {% if pregcheck_form.fields.pregnant.widget.attrs.disabled %}disabled{% endif %}>
    Submit Preg Check
  </button>
</form>
</div>

<div id="message-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="message-container"></div>
    <button id="continue-btn">Continue</button>
  </div>
</div>

<!-- Add this modal at the end of the template -->
<div id="new-animal-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <p id="modal-message"></p>
    <button id="record-pregcheck">Record Preg Check For New Animal</button>
    <button id="cancel">Cancel</button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('pregcheck-form');
    var searchForm = document.getElementById('search-form');
    var messageContainer = document.getElementById('message-container');
    var modal = document.getElementById('message-modal');
    var continueBtn = document.getElementById('continue-btn');
    var resultContainer = document.querySelector('.result-container');

    form.addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent normal form submission
      var formData = new FormData(form);

      var xhr = new XMLHttpRequest();
      xhr.open(form.method, form.action, true);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      xhr.onload = function() {
        if (xhr.status === 200) {
          // Display success message
          messageContainer.textContent = 'PregCheck created successfully';
          messageContainer.classList.add('success');
          modal.style.display = 'block';

        // Reset the form inputs
        form.reset();
        document.getElementById('id_search_animal_id').value = '';
        // Remove animal_id input and label
        var animalIdInput = document.getElementById('id_pregcheck_animal_id');
        var animalIdLabel = document.querySelector('label[for="id_pregcheck_animal_id"]');
        if (animalIdInput && animalIdLabel) {
              animalIdInput.remove();
              animalIdLabel.remove();
        }

        // Clear result container
        var resultContainer = document.querySelector('.result-container');
        if (resultContainer) {
              resultContainer.innerHTML = '';
        }

        // Remove query parameters from URL
        if (window.history && window.history.replaceState) {
              var newUrl = window.location.href.split('?')[0];
              window.history.replaceState({ path: newUrl }, '', newUrl);
        }
        } else {
          // Display error message
          messageContainer.textContent = 'Something went wrong';
          messageContainer.classList.add('error');
          modal.style.display = 'block';
        }
      };
      xhr.onerror = function() {
        // Display error message
        messageContainer.textContent = 'Something went wrong';
        messageContainer.classList.add('error');
        modal.style.display = 'block';
      };
      xhr.send(formData);
    });

    continueBtn.addEventListener('click', function() {
      modal.style.display = 'none';
    });

    var closeModal = function() {
      modal.style.display = 'none';
    };

    var closeBtn = document.querySelector('.close');
    if (closeBtn) {
      closeBtn.addEventListener('click', closeModal);
    }

    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        closeModal();
      }
    });

    // Initially hide the modal
    modal.style.display = 'none';
  });
</script>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ...

    var animalExists = "{{ animal_exists }}";
    console.log('above animal exists cond check');

    if (animalExists === "False") {
      console.log('animal exists False');

      modal.style.display = 'block';
      document.getElementById('modal-message').textContent = 'Animal does not exist.';
      document.getElementById('record-pregcheck').addEventListener('click', function() {
        var animalIdInput = document.getElementById('id_pregcheck_animal_id');
        animalIdInput.value = formData.get('pregcheck_animal_id');
        animalIdInput.style.display = 'block';

        var birthYearInput = document.createElement('input');
        birthYearInput.type = 'text';
        birthYearInput.name = 'birth_year';
        birthYearInput.placeholder = 'Enter Birth Year';
        form.appendChild(birthYearInput);

        modal.style.display = 'none';
      });

      document.getElementById('cancel').addEventListener('click', function() {
        var searchAnimalIdInput = document.getElementById('id_search_animal_id');
        searchAnimalIdInput.value = '';
        modal.style.display = 'none';
      });
    }

    // ...
  });
</script>


